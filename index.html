<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Disc Golf Course Randomizer + Scorecard</title>
  <style>
    body{font-family:-apple-system,system-ui,sans-serif;margin:16px;line-height:1.35}
    button{font-size:16px;padding:10px 14px;margin:6px 6px 0 0}
    input[type=text]{font-size:16px;padding:8px;width:100%;box-sizing:border-box}
    select{font-size:16px;padding:6px 8px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border-bottom:1px solid #ddd;padding:6px;text-align:center;vertical-align:middle}
    th{background:#f5f5f5}
    .right{text-align:right}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px;margin-top:12px}
    .pill{background:#eee;border-radius:999px;padding:2px 8px;font-size:12px;display:inline-block}
    .muted{color:#666;font-size:13px}
    .ok{color:#0a7;font-weight:700}
    .bad{color:#c33;font-weight:800}
    @media print{.no-print{display:none}}
  </style>
</head>
<body>

<div class="no-print">
  <h1>Disc Golf Course Randomizer</h1>
  <div class="muted">
    Rules: start not green • hole 9 & 18 = green • no consecutive repeats • directional rules • each goal ≥2 • no repeated throws (same from→to once).
    <br>
    Updates: tee→white is Par 3 • pink↔green disallowed.
  </div>
  <button id="btnGen">Generate Course</button>
  <button id="btnCopy">Copy Course + Scores</button>
  <button id="btnReset">Reset Scores</button>
  <button onclick="window.print()">Print / PDF</button>
  <div id="status" class="muted" style="margin-top:8px;"></div>
</div>

<div class="card">
  <h2 style="margin:0 0 6px 0;">Course</h2>
  <table>
    <thead>
      <tr><th>Hole</th><th>From</th><th>To</th><th>Par</th></tr>
    </thead>
    <tbody id="courseBody"></tbody>
    <tfoot>
      <tr><th colspan="3" class="right">Front 9 Par</th><th id="parFront" class="right"></th></tr>
      <tr><th colspan="3" class="right">Back 9 Par</th><th id="parBack" class="right"></th></tr>
      <tr><th colspan="3" class="right">Total Par</th><th id="parTotal" class="right"></th></tr>
    </tfoot>
  </table>
</div>

<div class="card">
  <h2 style="margin:0 0 6px 0;">Scorecard</h2>
  <table>
    <thead>
      <tr>
        <th>Hole</th><th>Par</th>
        <th><input id="n1" placeholder="Player 1"></th>
        <th><input id="n2" placeholder="Player 2"></th>
        <th><input id="n3" placeholder="Player 3"></th>
        <th><input id="n4" placeholder="Player 4"></th>
      </tr>
    </thead>
    <tbody id="scoreBody"></tbody>
    <tfoot>
      <tr>
        <th colspan="2" class="right">Front 9</th>
        <th><span id="f1">0</span> <span id="fd1" class="pill">E</span></th>
        <th><span id="f2">0</span> <span id="fd2" class="pill">E</span></th>
        <th><span id="f3">0</span> <span id="fd3" class="pill">E</span></th>
        <th><span id="f4">0</span> <span id="fd4" class="pill">E</span></th>
      </tr>
      <tr>
        <th colspan="2" class="right">Back 9</th>
        <th><span id="b1">0</span> <span id="bd1" class="pill">E</span></th>
        <th><span id="b2">0</span> <span id="bd2" class="pill">E</span></th>
        <th><span id="b3">0</span> <span id="bd3" class="pill">E</span></th>
        <th><span id="b4">0</span> <span id="bd4" class="pill">E</span></th>
      </tr>
      <tr>
        <th colspan="2" class="right">Total</th>
        <th><span id="t1">0</span> <span id="d1" class="pill">E</span></th>
        <th><span id="t2">0</span> <span id="d2" class="pill">E</span></th>
        <th><span id="t3">0</span> <span id="d3" class="pill">E</span></th>
        <th><span id="t4">0</span> <span id="d4" class="pill">E</span></th>
      </tr>
    </tfoot>
  </table>
</div>

<script>
(function(){
  // ---------- CONFIG ----------
  var GOALS = ["white","orange","blue","pink","red","green","yellow"];
  var HOLES = 18;
  var MINREQ = 2;
  var FIXED = { 9: "green", 18: "green" };

  // Directional restrictions (prev -> next disallowed)
  // Updated: disallow pink<->green both ways
  var DIS = {
    "white":  [],
    "orange": ["pink","blue"],
    "blue":   ["orange","red"],
    "pink":   ["orange","red","green"], // added green
    "red":    ["blue","pink"],
    "green":  ["yellow","pink"],        // added pink
    "yellow": ["green"]
  };

  // Par rules:
  // Hole 1 (tee -> goal): Par 3 to yellow/pink/white; else Par 4.
  var HOLE1_PAR3_TO = { "yellow": true, "pink": true, "white": true };

  // Pair-based par rules for holes 2-18 (both directions)
  function pairKey(a,b){ return (a < b) ? (a+"|"+b) : (b+"|"+a); }
  var PAR3 = {};
  var PAR5 = {};

  // Par 3 pairs (REMOVED green<->pink because that throw is no longer allowed)
  [
    ["white","yellow"],
    ["white","green"],
    ["yellow","red"],
    ["yellow","pink"],
    ["green","red"],
    ["red","orange"],
    ["red","blue"]
  ].forEach(function(p){ PAR3[pairKey(p[0],p[1])] = true; });

  // Par 5 pairs
  [
    ["white","blue"],
    ["white","orange"]
  ].forEach(function(p){ PAR5[pairKey(p[0],p[1])] = true; });

  // ---------- HELPERS ----------
  function allowed(prev, next){
    if (!prev) return true;
    if (prev === next) return false; // no consecutive repeats
    var bad = DIS[prev] || [];
    for (var i=0;i<bad.length;i++) if (bad[i]===next) return false;
    return true;
  }

  function edgeKey(from,to){ return from + "->" + to; } // unique throws are directional

  function shuffle(arr){
    for (var i=arr.length-1;i>0;i--){
      var j = Math.floor(Math.random()*(i+1));
      var t = arr[i]; arr[i]=arr[j]; arr[j]=t;
    }
    return arr;
  }

  function initCounts(){
    var c = {};
    for (var i=0;i<GOALS.length;i++) c[GOALS[i]] = 0;
    return c;
  }

  function futureFixedCount(goal, fromPos){
    var f=0;
    for (var h=fromPos; h<=HOLES; h++){
      if (FIXED[h] === goal) f++;
    }
    return f;
  }

  function remainingUnfixedSlots(fromPos, course){
    var s=0;
    for (var h=fromPos; h<=HOLES; h++){
      if (!FIXED[h] && course[h] === null) s++;
    }
    return s;
  }

  function minNeeded(fromPos, course, used){
    var need=0;
    for (var i=0;i<GOALS.length;i++){
      var g = GOALS[i];
      var future = futureFixedCount(g, fromPos);
      var missing = MINREQ - (used[g] + future);
      if (missing > 0) need += missing;
    }
    return need;
  }

  function feasible(fromPos, course, used){
    return minNeeded(fromPos, course, used) <= remainingUnfixedSlots(fromPos, course);
  }

  function candidateScore(goal, used, fromPos){
    var future = futureFixedCount(goal, fromPos);
    var willHave = used[goal] + future;
    if (willHave < MINREQ) return -100 + used[goal]; // strongly prefer under-min goals
    return used[goal];
  }

  function parFor(from,to,hole){
    if (hole === 1){
      return HOLE1_PAR3_TO[to] ? 3 : 4;
    }
    var k = pairKey(from,to);
    if (PAR5[k]) return 5;
    if (PAR3[k]) return 3;
    return 4;
  }

  function formatDiff(d){
    if (d===0) return "E";
    if (d>0) return "+"+d;
    return ""+d;
  }

  // ---------- GENERATOR ----------
  function generateCourse(){
    var course = [];
    for (var i=0;i<=HOLES;i++) course[i]=null;

    // set fixed holes
    for (var h in FIXED) if (FIXED.hasOwnProperty(h)) course[parseInt(h,10)] = FIXED[h];

    var used = initCounts();
    var usedEdges = {}; // from->to edge used

    function bt(pos){
      if (pos > HOLES){
        for (var i=0;i<GOALS.length;i++){
          if (used[GOALS[i]] < MINREQ) return false;
        }
        return true;
      }

      var prevGoal = (pos===1) ? "tee" : course[pos-1];

      // fixed hole
      if (course[pos] !== null){
        var v = course[pos];

        // start cannot be green
        if (pos === 1 && v === "green") return false;

        // transition must be allowed for pos>1
        if (pos > 1 && !allowed(course[pos-1], v)) return false;

        // unique throw (from->to)
        var ek = edgeKey(prevGoal, v);
        if (usedEdges[ek]) return false;

        usedEdges[ek] = true;
        used[v] += 1;

        if (!feasible(pos+1, course, used)) { used[v]-=1; delete usedEdges[ek]; return false; }
        if (bt(pos+1)) return true;

        used[v] -= 1;
        delete usedEdges[ek];
        return false;
      }

      // choose candidate next goals
      var prev2 = (pos>1) ? course[pos-1] : null;
      var cands = [];

      for (var i2=0;i2<GOALS.length;i2++){
        var g2 = GOALS[i2];

        if (pos === 1 && g2 === "green") continue;
        if (pos > 1 && !allowed(prev2, g2)) continue;

        // ensure g2 -> next fixed hole transition is allowed
        if (course[pos+1] !== null && !allowed(g2, course[pos+1])) continue;

        // unique throw
        if (usedEdges[edgeKey(prevGoal, g2)]) continue;

        cands.push(g2);
      }

      shuffle(cands);
      cands.sort(function(a,b){
        return candidateScore(a, used, pos+1) - candidateScore(b, used, pos+1);
      });

      for (var ci=0; ci<cands.length; ci++){
        var pick = cands[ci];
        var ek2 = edgeKey(prevGoal, pick);

        course[pos] = pick;
        used[pick] += 1;
        usedEdges[ek2] = true;

        if (feasible(pos+1, course, used) && bt(pos+1)) return true;

        delete usedEdges[ek2];
        used[pick] -= 1;
        course[pos] = null;
      }

      return false;
    }

    // Try multiple attempts for randomness
    for (var attempt=1; attempt<=20000; attempt++){
      // reset non-fixed holes
      for (var p=1; p<=HOLES; p++){
        if (!FIXED[p]) course[p] = null;
      }
      used = initCounts();
      usedEdges = {};

      if (bt(1)){
        var seq = [];
        for (var k=1;k<=HOLES;k++) seq.push(course[k]);
        return { seq: seq, attempt: attempt };
      }
    }

    return null;
  }

  // ---------- RENDER ----------
  var courseBody = document.getElementById("courseBody");
  var scoreBody  = document.getElementById("scoreBody");
  var statusEl   = document.getElementById("status");

  function makeSelect(hole, player){
    var sel = document.createElement("select");
    sel.setAttribute("data-hole", ""+hole);
    sel.setAttribute("data-player", ""+player);

    var opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "–";
    sel.appendChild(opt0);

    for (var i=1;i<=10;i++){
      var opt = document.createElement("option");
      opt.value = ""+i;
      opt.textContent = ""+i;
      sel.appendChild(opt);
    }

    sel.addEventListener("change", recalcTotals);
    return sel;
  }

  function renderAll(seq){
    courseBody.innerHTML = "";
    scoreBody.innerHTML = "";

    var pars = [];
    var parFront = 0, parBack = 0, parTotal = 0;

    for (var i=0;i<seq.length;i++){
      var hole = i+1;
      var to = seq[i];
      var from = (i===0) ? "tee" : seq[i-1];
      var p = parFor(from,to,hole);
      pars.push(p);

      parTotal += p;
      if (hole<=9) parFront += p; else parBack += p;

      var mark = (hole===9 || hole===18) ? " ✅" : "";
      var tr = document.createElement("tr");
      tr.innerHTML = "<td>"+hole+"</td><td>"+from+"</td><td>"+to+mark+"</td><td>"+p+"</td>";
      courseBody.appendChild(tr);

      // Score row
      var trS = document.createElement("tr");
      trS.appendChild(tdText(""+hole));
      trS.appendChild(tdText(""+p));

      for (var pl=1; pl<=4; pl++){
        var td = document.createElement("td");
        td.appendChild(makeSelect(hole, pl));
        trS.appendChild(td);
      }
      scoreBody.appendChild(trS);
    }

    document.getElementById("parFront").textContent = ""+parFront;
    document.getElementById("parBack").textContent  = ""+parBack;
    document.getElementById("parTotal").textContent = ""+parTotal;

    window.__seq = seq;
    window.__pars = pars;
    window.__parFront = parFront;
    window.__parBack = parBack;
    window.__parTotal = parTotal;

    recalcTotals();
  }

  function tdText(txt){
    var td = document.createElement("td");
    td.textContent = txt;
    return td;
  }

  function recalcTotals(){
    var parFront = window.__parFront || 0;
    var parBack  = window.__parBack  || 0;
    var parTotal = window.__parTotal || 0;

    for (var pl=1; pl<=4; pl++){
      var f=0,b=0,t=0;

      for (var hole=1; hole<=HOLES; hole++){
        var sel = scoreBody.querySelector('select[data-hole="'+hole+'"][data-player="'+pl+'"]');
        if (!sel) continue;
        var v = sel.value;
        if (v !== ""){
          var n = parseInt(v,10);
          if (!isNaN(n)){
            t += n;
            if (hole<=9) f += n; else b += n;
          }
        }
      }

      document.getElementById("f"+pl).textContent = ""+f;
      document.getElementById("b"+pl).textContent = ""+b;
      document.getElementById("t"+pl).textContent = ""+t;

      document.getElementById("fd"+pl).textContent = formatDiff(f - parFront);
      document.getElementById("bd"+pl).textContent = formatDiff(b - parBack);
      document.getElementById("d"+pl).textContent  = formatDiff(t - parTotal);
    }
  }

  function resetScores(){
    var sels = scoreBody.querySelectorAll("select");
    for (var i=0;i<sels.length;i++) sels[i].value = "";
    recalcTotals();
  }

  function copyAll(){
    if (!window.__seq) return;

    var names = [
      document.getElementById("n1").value || "Player 1",
      document.getElementById("n2").value || "Player 2",
      document.getElementById("n3").value || "Player 3",
      document.getElementById("n4").value || "Player 4"
    ];

    var lines = [];
    lines.push("Disc Golf Course (18 holes)");
    for (var i=0;i<window.__seq.length;i++){
      var hole=i+1;
      var from=(i===0)?"tee":window.__seq[i-1];
      var to=window.__seq[i];
      var p=window.__pars[i];
      lines.push("Hole "+hole+": "+from+" -> "+to+" (Par "+p+")");
    }
    lines.push("Front 9 Par: "+window.__parFront);
    lines.push("Back 9 Par: "+window.__parBack);
    lines.push("Total Par: "+window.__parTotal);
    lines.push("");
    lines.push("Scores:");

    for (var pl=1; pl<=4; pl++){
      var f=0,b=0,t=0;
      for (var hole=1; hole<=HOLES; hole++){
        var sel = scoreBody.querySelector('select[data-hole="'+hole+'"][data-player="'+pl+'"]');
        var v = sel ? sel.value : "";
        if (v !== ""){
          var n = parseInt(v,10);
          if (!isNaN(n)){
            t += n;
            if (hole<=9) f += n; else b += n;
          }
        }
      }
      lines.push(
        names[pl-1] + ": " +
        "Front " + f + " (" + formatDiff(f-window.__parFront) + "), " +
        "Back " + b + " (" + formatDiff(b-window.__parBack) + "), " +
        "Total " + t + " (" + formatDiff(t-window.__parTotal) + ")"
      );
    }

    var txt = lines.join("\n");
    if (navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(txt).then(function(){
        statusEl.innerHTML = "<span class='ok'>Copied.</span>";
      }).catch(function(){
        window.prompt("Copy this:", txt);
      });
    } else {
      window.prompt("Copy this:", txt);
    }
  }

  function doGenerate(){
    statusEl.textContent = "Generating...";
    var r = generateCourse();
    if (!r){
      statusEl.innerHTML = "<span class='bad'>Could not generate.</span> Try again (rules are strict).";
      return;
    }
    renderAll(r.seq);
    statusEl.innerHTML = "<span class='ok'>Generated!</span> (attempt "+r.attempt+")";
  }

  // ---------- WIRE UP ----------
  document.getElementById("btnGen").addEventListener("click", doGenerate);
  document.getElementById("btnCopy").addEventListener("click", copyAll);
  document.getElementById("btnReset").addEventListener("click", resetScores);

  // initial generate
  doGenerate();
})();
</script>

</body>
</html>
