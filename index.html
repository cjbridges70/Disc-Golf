<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Disc Golf Course Randomizer</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: -apple-system, system-ui, Segoe UI, Roboto, sans-serif; margin: 18px; line-height: 1.35; }
    button { font-size: 16px; padding: 10px 14px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 0; align-items: center; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; max-width: 860px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border-bottom: 1px solid #eee; padding: 8px 6px; text-align: left; }
    th { background: #fafafa; position: sticky; top: 0; }
    .muted { color: #666; font-size: 13px; }
    .ok { color: #0a7; font-weight: 600; }
    .bad { color: #c33; font-weight: 700; }
    code { background: #f6f6f6; padding: 2px 5px; border-radius: 6px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #f3f3f3; font-size: 13px; }
    .grid2 { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 920px) { .grid2 { grid-template-columns: 1fr 1fr; } }

    .print-only { display: none; }
    @media print {
      body { margin: 10mm; }
      .no-print { display: none !important; }
      .print-only { display: block; }
      .card { border: none; padding: 0; max-width: none; }
      th { position: static; }
      table { font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="no-print">
    <h1>Disc Golf Course Randomizer</h1>
    <p class="muted">
      Rules enforced:
      <span class="pill">18 holes</span>
      <span class="pill">Hole 9 = green</span>
      <span class="pill">Hole 18 = green</span>
      <span class="pill">Each goal ≥ 2 uses</span>
      <span class="pill">No consecutive repeats</span>
      <span class="pill">Start random, not green</span>
      <br>
      Transition rules are directional: Hole i → Hole i+1.
    </p>

    <div class="row">
      <button id="gen">Generate Course</button>
      <button id="copy">Copy Course</button>
      <button id="downloadCsv">Download CSV</button>
      <button id="print">Print / Save as PDF (Scorecard)</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h2 style="margin-top:0;">Course (Goals per Hole)</h2>
      <table id="courseTable" aria-label="Course table">
        <thead><tr><th>Hole</th><th>Goal</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="card">
      <h2 style="margin-top:0;">Counts</h2>
      <div id="counts" class="muted"></div>
      <hr style="border:none;border-top:1px solid #eee;margin:12px 0;">
      <div class="muted">
        If “Generate Course” does nothing, the page likely opened in iOS Quick Look (preview), not Safari.
        Open it in Safari (steps below).
      </div>
    </div>
  </div>

  <div class="print-only">
    <h1 style="margin:0 0 4mm 0;">Disc Golf Scorecard</h1>
    <div class="muted" style="margin:0 0 4mm 0;">
      Date: _________ &nbsp;&nbsp; Players: ________________________________
    </div>
  </div>

  <div class="card print-only">
    <table id="scorecardTable" aria-label="Scorecard">
      <thead>
        <tr>
          <th>Hole</th>
          <th>Goal</th>
          <th>Player 1</th>
          <th>Player 2</th>
          <th>Player 3</th>
          <th>Player 4</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="muted" style="margin-top:3mm;">
      Tip: In the print dialog, choose “Save as PDF” to export.
    </div>
  </div>

<script>
(function () {
  var GOALS = ["white", "orange", "blue", "pink", "red", "green", "yellow"];
  var HOLES = 18;
  var FIXED = { 9: "green", 18: "green" };

  var DISALLOWED_NEXT = {
    "white":  [],
    "orange": ["pink", "blue"],
    "blue":   ["orange", "red"],
    "pink":   ["orange", "red"],
    "red":    ["blue", "pink"],
    "green":  ["yellow"],
    "yellow": ["green"]
  };

  function contains(arr, value) {
    for (var i = 0; i < arr.length; i++) if (arr[i] === value) return true;
    return false;
  }

  function shuffle(arr) {
    for (var i = arr.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
    }
    return arr;
  }

  function allowedTransition(prev, next) {
    if (!prev) return true;
    if (prev === next) return false;
    var bad = DISALLOWED_NEXT[prev] || [];
    return !contains(bad, next);
  }

  function buildCounts() {
    var counts = {};
    for (var i = 0; i < GOALS.length; i++) counts[GOALS[i]] = 2;

    var extra = HOLES - (2 * GOALS.length);
    while (extra > 0) {
      var g = GOALS[Math.floor(Math.random() * GOALS.length)];
      counts[g] = counts[g] + 1;
      extra--;
    }
    return counts;
  }

  function countsSum(counts) {
    var s = 0;
    for (var i = 0; i < GOALS.length; i++) s += counts[GOALS[i]];
    return s;
  }

  function generateCourseOnce() {
    var counts = buildCounts();
    var course = [];
    for (var i = 0; i <= HOLES; i++) course[i] = null;

    for (var hole in FIXED) {
      if (!FIXED.hasOwnProperty(hole)) continue;
      var h = parseInt(hole, 10);
      var goal = FIXED[hole];
      course[h] = goal;
      counts[goal] = counts[goal] - 1;
      if (counts[goal] < 0) return null;
    }

    function fill(holeNum) {
      if (holeNum > HOLES) return true;

      if (course[holeNum]) {
        var prevFixed = course[holeNum - 1];
        if (!allowedTransition(prevFixed, course[holeNum])) return false;
        return fill(holeNum + 1);
      }

      var prev = course[holeNum - 1];
      var candidates = [];
      for (var gi = 0; gi < GOALS.length; gi++) {
        var g = GOALS[gi];
        if (counts[g] > 0 && allowedTransition(prev, g)) candidates.push(g);
      }

      if (holeNum === 1) {
        var filtered = [];
        for (var ci = 0; ci < candidates.length; ci++) {
          if (candidates[ci] !== "green") filtered.push(candidates[ci]);
        }
        candidates = filtered;
      }

      shuffle(candidates);

      for (var ci2 = 0; ci2 < candidates.length; ci2++) {
        var pick = candidates[ci2];
        course[holeNum] = pick;
        counts[pick] = counts[pick] - 1;

        var nextFixed = course[holeNum + 1];
        if (nextFixed && !allowedTransition(pick, nextFixed)) {
          counts[pick] = counts[pick] + 1;
          course[holeNum] = null;
          continue;
        }

        var slotsLeft = HOLES - holeNum;
        if (countsSum(counts) !== slotsLeft) {
          counts[pick] = counts[pick] + 1;
          course[holeNum] = null;
          continue;
        }

        if (fill(holeNum + 1)) return true;

        counts[pick] = counts[pick] + 1;
        course[holeNum] = null;
      }

      return false;
    }

    if (!fill(1)) return null;

    var finalCounts = {};
    for (var gi2 = 0; gi2 < GOALS.length; gi2++) finalCounts[GOALS[gi2]] = 0;
    for (var h2 = 1; h2 <= HOLES; h2++) finalCounts[course[h2]]++;

    if (course[9] !== "green" || course[18] !== "green") return null;
    if (course[1] === "green") return null;

    for (var h3 = 1; h3 < HOLES; h3++) {
      if (!allowedTransition(course[h3], course[h3 + 1])) return null;
    }

    for (var gi3 = 0; gi3 < GOALS.length; gi3++) {
      var gg = GOALS[gi3];
      if (finalCounts[gg] < 2) return null;
    }

    var outCourse = [];
    for (var h4 = 1; h4 <= HOLES; h4++) outCourse.push(course[h4]);
    return { course: outCourse, counts: finalCounts };
  }

  function generateCourse() {
    for (var attempt = 1; attempt <= 8000; attempt++) {
      var r = generateCourseOnce();
      if (r) { r.attempt = attempt; return r; }
    }
    return null;
  }

  function el(id) { return document.getElementById(id); }

  function clearChildren(node) {
    while (node.firstChild) node.removeChild(node.firstChild);
  }

  function render(result) {
    var statusEl = el("status");
    var tbody = document.querySelector("#courseTable tbody");
    var scoreTbody = document.querySelector("#scorecardTable tbody");
    var countsEl = el("counts");

    clearChildren(tbody);
    clearChildren(scoreTbody);

    if (!result) {
      statusEl.innerHTML = '<span class="bad">Could not generate a valid course.</span> Try again.';
      countsEl.textContent = "";
      window.__lastResult = null;
      return;
    }

    statusEl.innerHTML = '<span class="ok">Generated!</span> (attempt ' + result.attempt + ')';

    for (var i = 0; i < result.course.length; i++) {
      var holeNum = i + 1;
      var g = result.course[i];
      var fixedMark = (holeNum === 9 || holeNum === 18) ? " ✅" : "";

      var tr = document.createElement("tr");
      var td1 = document.createElement("td");
      td1.textContent = String(holeNum);
      var td2 = document.createElement("td");
      td2.textContent = g + fixedMark;
      tr.appendChild(td1); tr.appendChild(td2);
      tbody.appendChild(tr);

      var tr2 = document.createElement("tr");
      var sd1 = document.createElement("td"); sd1.textContent = String(holeNum);
      var sd2 = document.createElement("td"); sd2.textContent = g + fixedMark;
      tr2.appendChild(sd1); tr2.appendChild(sd2);
      for (var p = 0; p < 4; p++) tr2.appendChild(document.createElement("td"));
      scoreTbody.appendChild(tr2);
    }

    var parts = [];
    var sortedGoals = GOALS.slice().sort();
    for (var k = 0; k < sortedGoals.length; k++) {
      var key = sortedGoals[k];
      parts.push("<code>" + key + "</code>: " + result.counts[key]);
    }
    countsEl.innerHTML = parts.join(" &nbsp; | &nbsp; ");

    window.__lastResult = result;
  }

  function copyAsText() {
    var r = window.__lastResult;
    if (!r) return;

    var lines = [];
    for (var i = 0; i < r.course.length; i++) {
      var hole = i + 1;
      var holeStr = (hole < 10) ? ("0" + hole) : String(hole);
      lines.push("Hole " + holeStr + ": " + r.course[i]);
    }
    lines.push("");
    lines.push("Counts:");
    var sortedGoals = GOALS.slice().sort();
    for (var k = 0; k < sortedGoals.length; k++) {
      var g = sortedGoals[k];
      lines.push("- " + g + ": " + r.counts[g]);
    }
    var text = lines.join("\n");

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function () {
        el("status").innerHTML = '<span class="ok">Copied.</span>';
      }).catch(function () {
        window.prompt("Copy this:", text);
      });
    } else {
      window.prompt("Copy this:", text);
    }
  }

  function downloadCsv() {
    var r = window.__lastResult;
    if (!r) return;

    var rows = [["Hole","Goal"]];
    for (var i = 0; i < r.course.length; i++) rows.push([String(i+1), r.course[i]]);

    function csvEscape(s) {
      s = String(s);
      if (s.indexOf('"') !== -1) s = s.replace(/"/g, '""');
      if (s.indexOf(",") !== -1 || s.indexOf("\n") !== -1) s = '"' + s + '"';
      return s;
    }

    var lines = [];
    for (var ri = 0; ri < rows.length; ri++) {
      lines.push(csvEscape(rows[ri][0]) + "," + csvEscape(rows[ri][1]));
    }
    var csv = lines.join("\n");

    var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url;
    a.download = "disc_golf_course.csv";
    document.body.appendChild(a);
    a.click();
    a.parentNode.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function printScorecard() { window.print(); }

  function safeGenerate() {
    try { render(generateCourse()); }
    catch (e) {
      el("status").innerHTML = '<span class="bad">Error:</span> ' + (e && e.message ? e.message : String(e));
    }
  }

  el("gen").addEventListener("click", safeGenerate);
  el("copy").addEventListener("click", copyAsText);
  el("downloadCsv").addEventListener("click", downloadCsv);
  el("print").addEventListener("click", printScorecard);

  safeGenerate();
})();
</script>

</body>
</html>
