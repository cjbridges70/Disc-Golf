<!doctype html>
<html lang="en" data-theme="system">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bridges Park</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:#666666;
      --card:#ffffff;
      --border:#dddddd;
      --thead:#f5f5f5;
      --tableLine:#dddddd;
      --btnBg:#efefef;
      --btnText:#111111;

      --scoreUnder:#d1fae5;
      --scoreEven:#f3f4f6;
      --scoreOver:#fee2e2;

      --totalRow:#eef2ff;

      --accent:#9db775;
      --accentSoft:#eaf2de;

      --activeRow: var(--accentSoft);
      --activeBorder: var(--accent);

      --rowBg:#ffffff;
      --rowBorder:#e7e7e7;

      --progressTrack:#e9e9ef;
      --progressFill: var(--accent);

      --toastBg: rgba(20,20,22,0.92);
      --toastText: #fff;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0d10;
        --text:#e8e8e8;
        --muted:#a7a7a7;
        --card:#11151b;
        --border:#2a2f38;
        --thead:#171c24;
        --tableLine:#2a2f38;
        --btnBg:#1b2230;
        --btnText:#e8e8e8;

        --scoreUnder:#0f3b2b;
        --scoreEven:#202634;
        --scoreOver:#3b1416;

        --totalRow:#1b2341;

        --accent:#a8c986;
        --accentSoft:#172114;

        --activeRow: rgba(168,201,134,0.18);
        --activeBorder: var(--accent);

        --rowBg:#11151b;
        --rowBorder:#2a2f38;

        --progressTrack:#202634;
        --progressFill: var(--accent);
      }
    }

    html[data-theme="light"]{
      --bg:#ffffff; --text:#111111; --muted:#666666; --card:#ffffff;
      --border:#dddddd; --thead:#f5f5f5; --tableLine:#dddddd;
      --btnBg:#efefef; --btnText:#111111;
      --scoreUnder:#d1fae5; --scoreEven:#f3f4f6; --scoreOver:#fee2e2;
      --totalRow:#eef2ff;
      --accent:#9db775; --accentSoft:#eaf2de;
      --activeRow: var(--accentSoft);
      --activeBorder: var(--accent);
      --rowBg:#ffffff; --rowBorder:#e7e7e7;
      --progressTrack:#e9e9ef; --progressFill: var(--accent);
    }

    html[data-theme="dark"]{
      --bg:#0b0d10; --text:#e8e8e8; --muted:#a7a7a7; --card:#11151b;
      --border:#2a2f38; --thead:#171c24; --tableLine:#2a2f38;
      --btnBg:#1b2230; --btnText:#e8e8e8;
      --scoreUnder:#0f3b2b; --scoreEven:#202634; --scoreOver:#3b1416;
      --totalRow:#1b2341;
      --accent:#a8c986; --accentSoft:#172114;
      --activeRow: rgba(168,201,134,0.18);
      --activeBorder: var(--accent);
      --rowBg:#11151b; --rowBorder:#2a2f38;
      --progressTrack:#202634; --progressFill: var(--accent);
    }

    body{
      font-family:-apple-system,system-ui,sans-serif;
      margin:16px;
      line-height:1.3;
      background:var(--bg);
      color:var(--text);
    }
    .muted{color:var(--muted);font-size:12px}

    button { transition: transform 0.08s ease, background-color 0.15s ease, border-color 0.15s ease; }
    button:active { transform: scale(0.98); }

    .header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .headerLeft{
      display:flex;
      gap:12px;
      align-items:center;
      flex:1 1 auto;
      min-width:0;
    }
    .brand h1{margin:0;font-size:26px}
    .subtitle{margin-top:3px}

    .logoImg{
      width:58px;height:58px;border-radius:14px;object-fit:contain;
      border:none !important; outline:none !important; box-shadow:none !important;
      background:transparent;
      display:block;
      flex:0 0 auto;
    }

    .themeToggleBtn{
      width:44px;height:44px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      flex:0 0 auto;
    }
    .themeToggleBtn img{ width:22px;height:22px; display:block; }

    .infoGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .infoCard{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card);
      text-align:left;
    }
    .infoLabel{font-size:12px;color:var(--muted);margin:0}
    .infoValue{font-size:16px;font-weight:800;margin:3px 0 0 0}

    /* Legend stays outside (not sticky) */
    .legend{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .swatch{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .dot{
      width:12px;height:12px;
      box-sizing:border-box;
      border-radius:4px;
      border:1px solid var(--border);
      display:inline-block;
      flex:0 0 12px;
    }
    .dot-under{background:var(--scoreUnder)}
    .dot-even{background:var(--scoreEven)}
    .dot-over{background:var(--scoreOver)}

    button{
      font-size:16px;
      padding:12px 14px;
      width:100%;
      background:var(--btnBg);
      color:var(--btnText);
      border:1px solid var(--border);
      border-radius:12px;
      margin-top:10px;
    }

    .btnRowTwo{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .btnSecondary{
      font-size:14px;
      padding:11px 12px;
      background:transparent;
      margin-top:0;
    }

    .card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-top:14px;
      background:var(--card);
    }

    .nameBlock{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      margin-top:12px;
      background:var(--card);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .grow{flex:1 1 160px}
    input[type=text]{
      font-size:16px;
      padding:10px;
      width:100%;
      box-sizing:border-box;
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
    }

    /* Table / Scorecard */
    table{
      width:100%;
      margin-top:10px;
      border-collapse:separate;
      border-spacing:0 10px;
      table-layout:fixed;
    }

    th,td{
      padding:10px 8px;
      text-align:center;
      vertical-align:middle;
      overflow:hidden;
      text-overflow:clip; /* no ellipsis dots */
      white-space:nowrap;
    }
    .left{text-align:left}

    /* Sticky header INSIDE scorecard: progress + column headers */
    .scoreSticky{
      position: sticky;
      top: 0;
      z-index: 60;
      margin: -12px -12px 10px -12px; /* stretch to card edges */
      padding: 10px 12px 10px 12px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.10);
    }

    .progressWrap{
      display:flex;
      align-items:center;
      gap:10px;
      margin:0 0 10px 0;
    }
    .progressTrack{
      flex:1 1 auto;
      height:10px;
      border-radius:999px;
      background:var(--progressTrack);
      overflow:hidden;
      border:1px solid var(--border);
    }
    .progressFill{
      height:100%;
      width:0%;
      background:var(--progressFill);
      transition: width 0.25s ease;
    }
    .progressText{
      font-size:12px;
      color:var(--muted);
      min-width:84px;
      text-align:right;
    }

    /* Grid header row that matches column widths */
    .colHeader{
      display:grid;
      grid-template-columns:10% 44% 10% 18% 18%;
      gap:0;
      align-items:center;
      background: var(--thead);
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 8px;
      font-weight:800;
    }
    .colHeader > div{
      text-align:center;
      overflow:hidden;
      text-overflow:clip;
      white-space:nowrap;
    }

    /* Card-like hole rows */
    tbody tr.holeRow td{
      background:var(--rowBg);
      border-top:1px solid var(--rowBorder);
      border-bottom:1px solid var(--rowBorder);
    }
    tbody tr.holeRow td:first-child{
      border-left:1px solid var(--rowBorder);
      border-top-left-radius:14px;
      border-bottom-left-radius:14px;
    }
    tbody tr.holeRow td:last-child{
      border-right:1px solid var(--rowBorder);
      border-top-right-radius:14px;
      border-bottom-right-radius:14px;
    }

    tr.holeRow{ transition: background-color 0.2s ease, box-shadow 0.2s ease; }
    tr.holeRow.active td{ background:var(--activeRow); }
    tr.holeRow.active td:first-child{
      box-shadow: inset 4px 0 0 0 var(--activeBorder);
    }

    @keyframes pulseDone {
      0%   { transform: scale(1); }
      35%  { transform: scale(1.01); }
      100% { transform: scale(1); }
    }
    tr.holeRow.pulse td{ animation: pulseDone 0.22s ease; }

    .goalTag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:16px;
      min-width:46px;
      padding:0 6px;
      border-radius:999px;
      font-size:10px;
      box-sizing:border-box;
      line-height:1;
      white-space:nowrap;
      font-weight:800;
      text-transform:capitalize;
    }
    .goal-white{background:#ffffff;color:#111;border:1px solid #ddd}
    .goal-orange{background:#ff8a00;color:#111;border:1px solid rgba(0,0,0,0.08)}
    .goal-blue{background:#1f6feb;color:#fff;border:1px solid rgba(255,255,255,0.12)}
    .goal-pink{background:#ff5aa5;color:#111;border:1px solid rgba(0,0,0,0.08)}
    .goal-red{background:#e11d48;color:#fff;border:1px solid rgba(255,255,255,0.12)}
    .goal-green{background:#16a34a;color:#fff;border:1px solid rgba(255,255,255,0.12)}
    .goal-yellow{background:#ffd400;color:#111;border:1px solid rgba(0,0,0,0.08)}
    .goal-tee{background:#111;color:#fff;border:1px solid #111}

    .twoPip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      max-width:100%;
    }
    .arrow{
      font-size:12px;
      color:var(--muted);
      font-weight:800;
      flex:0 0 auto;
    }

    select{
      font-size:15px;
      padding:7px 8px;
      background:transparent;
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      min-width:58px;
      transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    }
    .score-under{background:var(--scoreUnder)}
    .score-even{background:var(--scoreEven)}
    .score-over{background:var(--scoreOver)}

    .pill{border-radius:999px;padding:2px 8px;font-size:12px;display:inline-block}
    .pill-under{background:var(--scoreUnder)}
    .pill-even{background:var(--scoreEven)}
    .pill-over{background:var(--scoreOver)}

    .sumCell{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:3px;
      line-height:1.1;
    }
    .sumDiff{
      font-size:18px;
      font-weight:900;
      padding:2px 10px;
      border-radius:999px;
      display:inline-block;
      min-width:42px;
    }
    .sumThrows{
      font-size:11px;
      color:var(--muted);
    }

    tfoot tr.totalRow th,
    tfoot tr.totalRow td{
      background:var(--totalRow);
      border-top:1px solid var(--rowBorder);
      border-bottom:1px solid var(--rowBorder);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:var(--toastBg);
      color:var(--toastText);
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      max-width:92vw;
      opacity:0;
      pointer-events:none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index:9999;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }
  </style>
</head>

<body>

  <div class="header">
    <div class="headerLeft">
      <img id="logoLight" class="logoImg"
           src="C542D141-EA75-4C1C-9345-50C8E08D9EE5.png"
           alt="Bridges Park logo">
      <img id="logoDark" class="logoImg"
           src="B19327BB-FD35-4A0C-8F34-56CC91793687.png"
           alt="Bridges Park logo (dark)"
           style="display:none;">
      <div class="brand">
        <h1>Bridges Park</h1>
        <div class="muted subtitle">Disc Golf • Course Generator + Scorecard</div>
      </div>
    </div>

    <button id="themeToggle" class="themeToggleBtn" aria-label="Toggle dark mode">
      <img id="themeIcon" src="moon.png" alt="Theme icon">
    </button>
  </div>

  <div class="infoGrid">
    <div class="infoCard">
      <p class="infoLabel">Holes</p>
      <p class="infoValue">18</p>
    </div>
    <div class="infoCard">
      <p class="infoLabel">Par (Front / Back / Total)</p>
      <p class="infoValue"><span id="parFrontTop">–</span> / <span id="parBackTop">–</span> / <span id="parTotalTop">–</span></p>
    </div>
  </div>

  <!-- Legend OUTSIDE -->
  <div class="legend">
    <div class="swatch"><span class="dot dot-under"></span> Under</div>
    <div class="swatch"><span class="dot dot-even"></span> Even</div>
    <div class="swatch"><span class="dot dot-over"></span> Over</div>
  </div>

  <button id="btnGen">Generate New Course</button>

  <div class="btnRowTwo">
    <button id="btnClear" class="btnSecondary">Clear Scores</button>
    <button id="btnCopyLink" class="btnSecondary">Copy Share Link</button>
  </div>

  <div class="nameBlock">
    <div class="row">
      <div class="grow">
        <input id="n1" type="text" placeholder="Player 1 name">
      </div>
      <div class="grow">
        <input id="n2" type="text" placeholder="Player 2 name">
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px 0;">Scorecard</h2>

    <!-- Sticky header INSIDE scorecard -->
    <div class="scoreSticky">
      <div class="progressWrap">
        <div class="progressTrack"><div id="progressFill" class="progressFill"></div></div>
        <div id="progressText" class="progressText">0 / 18</div>
      </div>

      <div class="colHeader" aria-hidden="true">
        <div>#</div>
        <div>Throw</div>
        <div>Par</div>
        <div id="p1HeadSticky">P1</div>
        <div id="p2HeadSticky">P2</div>
      </div>
    </div>

    <table>
      <!-- we keep the real header but hide it to avoid double headers;
           the sticky grid above is the visible header -->
      <thead style="display:none;">
        <tr>
          <th style="width:10%;">#</th>
          <th style="width:44%;">Throw</th>
          <th style="width:10%;">Par</th>
          <th style="width:18%;" id="p1Head">P1</th>
          <th style="width:18%;" id="p2Head">P2</th>
        </tr>
      </thead>

      <tbody id="mainBody"></tbody>

      <tfoot>
        <tr id="backRow">
          <th colspan="2" class="left">Back 9</th>
          <th id="parBackCell">–</th>
          <th>
            <div class="sumCell">
              <span id="bd1" class="sumDiff pill pill-even">0</span>
              <span id="b1" class="sumThrows">0</span>
            </div>
          </th>
          <th>
            <div class="sumCell">
              <span id="bd2" class="sumDiff pill pill-even">0</span>
              <span id="b2" class="sumThrows">0</span>
            </div>
          </th>
        </tr>
        <tr class="totalRow">
          <th colspan="2" class="left">Total</th>
          <th id="parTotalCell">–</th>
          <th>
            <div class="sumCell">
              <span id="d1" class="sumDiff pill pill-even">0</span>
              <span id="t1" class="sumThrows">0</span>
            </div>
          </th>
          <th>
            <div class="sumCell">
              <span id="d2" class="sumDiff pill pill-even">0</span>
              <span id="t2" class="sumThrows">0</span>
            </div>
          </th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div id="toast" class="toast">Saved</div>

<script>
(function(){
  var toastEl = document.getElementById("toast");
  var toastTimer = null;
  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(function(){ toastEl.classList.remove("show"); }, 1400);
  }

  // Best-effort haptics (iPhone Safari often doesn't support vibrate)
  function haptic(ms){
    try{ if (navigator && navigator.vibrate) navigator.vibrate(ms || 10); }catch(e){}
  }

  // Theme toggle
  var THEME_KEY = "bridgespark:theme";
  var html = document.documentElement;
  var themeBtn = document.getElementById("themeToggle");
  var themeIcon = document.getElementById("themeIcon");

  function systemIsDark(){
    return window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
  }
  function applyTheme(theme){
    html.setAttribute("data-theme", theme);
    var effectiveDark = (theme === "dark") ? true : (theme === "light" ? false : systemIsDark());
    themeIcon.src = effectiveDark ? "sun.png" : "moon.png";
    document.getElementById("logoLight").style.display = effectiveDark ? "none" : "block";
    document.getElementById("logoDark").style.display  = effectiveDark ? "block" : "none";
  }
  function loadTheme(){
    try{
      var t = localStorage.getItem(THEME_KEY);
      if (t === "light" || t === "dark" || t === "system") return t;
    }catch(e){}
    return "system";
  }
  function saveTheme(t){
    try{ localStorage.setItem(THEME_KEY, t); }catch(e){}
  }
  themeBtn.addEventListener("click", function(){
    var cur = html.getAttribute("data-theme") || "system";
    var effectiveDark = (cur === "dark") ? true : (cur === "light" ? false : systemIsDark());
    var next = effectiveDark ? "light" : "dark";
    saveTheme(next);
    applyTheme(next);
    haptic(10);
    showToast(next === "dark" ? "Dark mode" : "Light mode");
  });
  try{
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", function(){
      if ((html.getAttribute("data-theme") || "system") === "system") applyTheme("system");
    });
  }catch(e){}
  applyTheme(loadTheme());

  // Course generator rules
  var GOALS = ["white","orange","blue","pink","red","green","yellow"];
  var HOLES = 18;
  var MINREQ = 2;
  var FIXED = { 9: "green", 18: "green" };

  var DIS = {
    "white":  [],
    "orange": ["pink","blue"],
    "blue":   ["orange","red"],
    "pink":   ["orange","red","green"],
    "red":    ["blue","pink"],
    "green":  ["yellow","pink"],
    "yellow": ["green"]
  };

  var HOLE1_PAR3_TO = { "yellow": true, "pink": true, "white": true };

  function pairKey(a,b){ return (a < b) ? (a+"|"+b) : (b+"|"+a); }
  var PAR3 = {};
  var PAR5 = {};
  [
    ["white","yellow"],
    ["white","green"],
    ["yellow","red"],
    ["yellow","pink"],
    ["green","red"],
    ["red","orange"],
    ["red","blue"],
    ["blue","pink"]
  ].forEach(function(p){ PAR3[pairKey(p[0],p[1])] = true; });
  [
    ["white","blue"],
    ["white","orange"]
  ].forEach(function(p){ PAR5[pairKey(p[0],p[1])] = true; });

  function allowed(prev, next){
    if (!prev) return true;
    if (prev === next) return false;
    var bad = DIS[prev] || [];
    for (var i=0;i<bad.length;i++) if (bad[i]===next) return false;
    return true;
  }

  function edgeKey(from,to){ return from + "->" + to; }

  function shuffle(arr){
    for (var i=arr.length-1;i>0;i--){
      var j = Math.floor(Math.random()*(i+1));
      var t = arr[i]; arr[i]=arr[j]; arr[j]=t;
    }
    return arr;
  }

  function initCounts(){
    var c = {};
    for (var i=0;i<GOALS.length;i++) c[GOALS[i]] = 0;
    return c;
  }

  function futureFixedCount(goal, fromPos){
    var f=0;
    for (var h=fromPos; h<=HOLES; h++){
      if (FIXED[h] === goal) f++;
    }
    return f;
  }

  function remainingUnfixedSlots(fromPos, course){
    var s=0;
    for (var h=fromPos; h<=HOLES; h++){
      if (!FIXED[h] && course[h] === null) s++;
    }
    return s;
  }

  function minNeeded(fromPos, course, used){
    var need=0;
    for (var i=0;i<GOALS.length;i++){
      var g = GOALS[i];
      var future = futureFixedCount(g, fromPos);
      var missing = MINREQ - (used[g] + future);
      if (missing > 0) need += missing;
    }
    return need;
  }

  function feasible(fromPos, course, used){
    return minNeeded(fromPos, course, used) <= remainingUnfixedSlots(fromPos, course);
  }

  function candidateScore(goal, used, fromPos){
    var future = futureFixedCount(goal, fromPos);
    var willHave = used[goal] + future;
    if (willHave < MINREQ) return -100 + used[goal];
    return used[goal];
  }

  function parFor(from,to,hole){
    if (hole === 1){
      return HOLE1_PAR3_TO[to] ? 3 : 4;
    }
    var k = pairKey(from,to);
    if (PAR5[k]) return 5;
    if (PAR3[k]) return 3;
    return 4;
  }

  function goalSpan(goal){
    var s = document.createElement("span");
    s.className = "goalTag goal-" + goal;
    s.textContent = goal;
    return s;
  }

  function generateCourse(){
    var course = [];
    for (var i=0;i<=HOLES;i++) course[i]=null;
    for (var h in FIXED) if (FIXED.hasOwnProperty(h)) course[parseInt(h,10)] = FIXED[h];

    var used = initCounts();
    var usedEdges = {};

    function bt(pos){
      if (pos > HOLES){
        for (var i=0;i<GOALS.length;i++){
          if (used[GOALS[i]] < MINREQ) return false;
        }
        return true;
      }

      var prevGoal = (pos===1) ? "tee" : course[pos-1];

      if (course[pos] !== null){
        var v = course[pos];
        if (pos === 1 && v === "green") return false;

        var ek = edgeKey(prevGoal, v);
        if (usedEdges[ek]) return false;

        usedEdges[ek] = true;
        used[v] += 1;

        if (!feasible(pos+1, course, used)) { used[v]-=1; delete usedEdges[ek]; return false; }
        if (bt(pos+1)) return true;

        used[v] -= 1;
        delete usedEdges[ek];
        return false;
      }

      var prev2 = (pos>1) ? course[pos-1] : null;
      var cands = [];

      for (var i2=0;i2<GOALS.length;i2++){
        var g2 = GOALS[i2];

        if (pos === 1 && g2 === "green") continue;
        if (pos > 1 && !allowed(prev2, g2)) continue;
        if (course[pos+1] !== null && !allowed(g2, course[pos+1])) continue;
        if (usedEdges[edgeKey(prevGoal, g2)]) continue;

        cands.push(g2);
      }

      shuffle(cands);
      cands.sort(function(a,b){
        return candidateScore(a, used, pos+1) - candidateScore(b, used, pos+1);
      });

      for (var ci=0; ci<cands.length; ci++){
        var pick = cands[ci];
        var ek2 = edgeKey(prevGoal, pick);

        course[pos] = pick;
        used[pick] += 1;
        usedEdges[ek2] = true;

        if (feasible(pos+1, course, used) && bt(pos+1)) return true;

        delete usedEdges[ek2];
        used[pick] -= 1;
        course[pos] = null;
      }

      return false;
    }

    for (var attempt=1; attempt<=25000; attempt++){
      for (var p=1; p<=HOLES; p++) if (!FIXED[p]) course[p] = null;
      used = initCounts();
      usedEdges = {};
      if (bt(1)){
        var seq = [];
        for (var k=1;k<=HOLES;k++) seq.push(course[k]);
        return { seq: seq };
      }
    }
    return null;
  }

  function decodeCourse(param){
    try{
      if (!param) return null;
      var raw = decodeURIComponent(param);
      var parts = raw.split(",").map(function(s){ return s.trim().toLowerCase(); }).filter(Boolean);
      if (parts.length !== HOLES) return null;

      for (var i=0;i<parts.length;i++){
        if (GOALS.indexOf(parts[i]) === -1) return null;
      }
      if (parts[8] !== "green") return null;
      if (parts[17] !== "green") return null;
      if (parts[0] === "green") return null;

      for (var h=2; h<=HOLES; h++){
        var prev = parts[h-2];
        var next = parts[h-1];
        if (prev === next) return null;
        if (!allowed(prev, next)) return null;
      }
      return parts;
    }catch(e){
      return null;
    }
  }

  function setUrlForCourse(seq){
    var url = new URL(window.location.href);
    url.searchParams.set("c", encodeURIComponent(seq.join(",")));
    history.replaceState(null, "", url.toString());
  }

  async function copyShareLink(){
    var link = window.location.href;
    try{
      await navigator.clipboard.writeText(link);
      haptic(10);
      showToast("Share link copied");
    }catch(e){
      prompt("Copy this link:", link);
    }
  }

  var currentSeq = null;
  var activeHole = 1;

  function storageKeyForCourse(courseStr){
    return "bridgespark:v5:" + courseStr;
  }

  var mainBody = document.getElementById("mainBody");
  var btnGen = document.getElementById("btnGen");
  var btnClear = document.getElementById("btnClear");
  var btnCopy = document.getElementById("btnCopyLink");
  var n1 = document.getElementById("n1");
  var n2 = document.getElementById("n2");

  var p1Sticky = document.getElementById("p1HeadSticky");
  var p2Sticky = document.getElementById("p2HeadSticky");

  var progressFill = document.getElementById("progressFill");
  var progressText = document.getElementById("progressText");

  function getSelectEl(hole, player){
    return mainBody.querySelector('select[data-hole="'+hole+'"][data-player="'+player+'"]');
  }
  function getSelectValue(hole, player){
    var sel = getSelectEl(hole, player);
    return sel ? sel.value : "";
  }
  function setSelectValue(hole, player, value){
    var sel = getSelectEl(hole, player);
    if (!sel) return;
    sel.value = (value === null || value === undefined) ? "" : String(value);
  }

  function saveState(){
    if (!currentSeq || currentSeq.length !== HOLES) return;
    var key = storageKeyForCourse(currentSeq.join(","));
    var scores = {};
    for (var hole=1; hole<=HOLES; hole++){
      scores[hole] = { p1: getSelectValue(hole,1), p2: getSelectValue(hole,2) };
    }
    var state = { n1: (n1.value||""), n2: (n2.value||""), activeHole: activeHole||1, scores: scores };
    try{ localStorage.setItem(key, JSON.stringify(state)); }catch(e){}
  }

  function loadState(){
    if (!currentSeq || currentSeq.length !== HOLES) return null;
    var key = storageKeyForCourse(currentSeq.join(","));
    try{
      var raw = localStorage.getItem(key);
      if (!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }

  function clearSavedStateForCurrentCourse(){
    if (!currentSeq || currentSeq.length !== HOLES) return;
    var key = storageKeyForCourse(currentSeq.join(","));
    try{ localStorage.removeItem(key); }catch(e){}
  }

  function playerName(idx){
    return (idx===1 ? (n1.value||"P1") : (n2.value||"P2")).trim();
  }
  function syncPlayerHeaders(){
    var a = playerName(1), b = playerName(2);
    p1Sticky.textContent = a;
    p2Sticky.textContent = b;
  }
  n1.addEventListener("input", function(){ syncPlayerHeaders(); saveState(); });
  n2.addEventListener("input", function(){ syncPlayerHeaders(); saveState(); });

  function setDiffPill(el, diff){
    el.classList.remove("pill-under","pill-even","pill-over");
    if (diff === 0) el.classList.add("pill-even");
    else if (diff > 0) el.classList.add("pill-over");
    else el.classList.add("pill-under");
  }

  var DELTAS = [-2,-1,0,1,2,3];

  function makeDeltaSelect(hole, player, parVal){
    var sel = document.createElement("select");
    sel.setAttribute("data-hole", ""+hole);
    sel.setAttribute("data-player", ""+player);
    sel.setAttribute("data-par", ""+parVal);

    var ph = document.createElement("option");
    ph.value = "";
    ph.textContent = "–";
    ph.selected = true;
    sel.appendChild(ph);

    for (var i=0;i<DELTAS.length;i++){
      var d = DELTAS[i];
      var opt = document.createElement("option");
      opt.value = ""+d;
      opt.textContent = (d>0 ? ("+"+d) : (""+d));
      sel.appendChild(opt);
    }

    sel.addEventListener("change", function(){
      colorDelta(sel);
      recalcTotals();
      updateProgress();
      saveState();
      haptic(8);

      if (bothSelected(hole)){
        pulseHoleRow(hole);
        setActiveHole(Math.min(HOLES, hole+1), true); // keep auto-scroll on hole completion
      } else {
        setActiveHole(hole, false);
      }
    });

    colorDelta(sel);
    return sel;
  }

  function colorDelta(sel){
    sel.classList.remove("score-under","score-even","score-over");
    var raw = sel.value;
    if (raw === ""){ sel.classList.add("score-even"); return; }
    var d = parseInt(raw,10);
    if (d < 0) sel.classList.add("score-under");
    else if (d > 0) sel.classList.add("score-over");
    else sel.classList.add("score-even");
  }

  function bothSelected(hole){
    return (getSelectValue(hole,1) !== "" && getSelectValue(hole,2) !== "");
  }

  function holeRowEl(hole){
    return mainBody.querySelector('tr.holeRow[data-hole="'+hole+'"]');
  }

  function pulseHoleRow(hole){
    var row = holeRowEl(hole);
    if (!row) return;
    row.classList.add("pulse");
    setTimeout(function(){ row.classList.remove("pulse"); }, 260);
  }

  function setActiveHole(hole, shouldScroll){
    activeHole = hole;
    var rows = mainBody.querySelectorAll("tr.holeRow");
    for (var i=0;i<rows.length;i++) rows[i].classList.remove("active");
    var row = holeRowEl(hole);
    if (row){
      row.classList.add("active");
      if (shouldScroll){
        try{ row.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){ row.scrollIntoView(); }
      }
    }
    saveState();
  }

  function anyScoreEntered(){
    for (var h=1; h<=HOLES; h++){
      if (getSelectValue(h,1) !== "" || getSelectValue(h,2) !== "") return true;
    }
    return false;
  }

  function recolorAllSelects(){
    var sels = mainBody.querySelectorAll("select");
    for (var i=0;i<sels.length;i++) colorDelta(sels[i]);
  }

  function recalcTotals(){
    for (var pl=1; pl<=2; pl++){
      var frontDelta=0, backDelta=0, totalDelta=0;
      var frontThrows=0, backThrows=0, totalThrows=0;

      for (var hole=1; hole<=HOLES; hole++){
        var sel = getSelectEl(hole, pl);
        if (!sel) continue;

        var par = parseInt(sel.getAttribute("data-par"),10) || 0;
        var raw = sel.value;
        var d = (raw === "") ? 0 : (parseInt(raw,10) || 0);

        totalDelta += d;
        if (hole<=9) frontDelta += d; else backDelta += d;

        var throws = par + d;
        totalThrows += throws;
        if (hole<=9) frontThrows += throws; else backThrows += throws;
      }

      document.getElementById("f"+pl).textContent = ""+frontThrows;
      document.getElementById("b"+pl).textContent = ""+backThrows;
      document.getElementById("t"+pl).textContent = ""+totalThrows;

      var fd = document.getElementById("fd"+pl);
      var bd = document.getElementById("bd"+pl);
      var dEl = document.getElementById("d"+pl);

      if (fd){
        fd.textContent = ""+frontDelta;
        setDiffPill(fd, frontDelta);
      }
      bd.textContent = ""+backDelta;
      dEl.textContent = ""+totalDelta;

      setDiffPill(bd, backDelta);
      setDiffPill(dEl, totalDelta);
    }
  }

  function updateProgress(){
    var completed = 0;
    for (var h=1; h<=HOLES; h++){
      if (bothSelected(h)) completed++;
    }
    var pct = Math.round((completed / HOLES) * 100);
    progressFill.style.width = pct + "%";
    progressText.textContent = completed + " / " + HOLES;
  }

  function clearScores(alsoClearStorage){
    for (var h=1; h<=HOLES; h++){
      setSelectValue(h, 1, "");
      setSelectValue(h, 2, "");
    }
    recolorAllSelects();
    recalcTotals();
    updateProgress();
    setActiveHole(1, true);

    if (alsoClearStorage) clearSavedStateForCurrentCourse();
    saveState();
    haptic(12);
    showToast("Scores cleared");
  }

  function buildFront9Row(frontPar){
    var tr = document.createElement("tr");
    tr.innerHTML = `
      <th colspan="2" class="left">Front 9</th>
      <th>${frontPar}</th>
      <th>
        <div class="sumCell">
          <span id="fd1" class="sumDiff pill pill-even">0</span>
          <span id="f1" class="sumThrows">0</span>
        </div>
      </th>
      <th>
        <div class="sumCell">
          <span id="fd2" class="sumDiff pill pill-even">0</span>
          <span id="f2" class="sumThrows">0</span>
        </div>
      </th>
    `;
    return tr;
  }

  function renderAll(seq){
    currentSeq = seq.slice();
    mainBody.innerHTML = "";

    var parFront=0, parBack=0, parTotal=0;

    for (var i=0;i<seq.length;i++){
      var hole = i+1;
      var to = seq[i];
      var from = (i===0) ? "tee" : seq[i-1];
      var p = parFor(from,to,hole);

      parTotal += p;
      if (hole<=9) parFront += p; else parBack += p;

      var tr = document.createElement("tr");
      tr.className = "holeRow";
      tr.setAttribute("data-hole", ""+hole);

      tr.addEventListener("click", function(e){
        if (e && e.target && (e.target.tagName === "SELECT" || e.target.tagName === "OPTION")) return;
        var h = parseInt(this.getAttribute("data-hole"),10) || 1;
        setActiveHole(h, true);
      });

      var tdH = document.createElement("td");
      tdH.textContent = ""+hole;
      tr.appendChild(tdH);

      var tdThrow = document.createElement("td");
      var wrap = document.createElement("span");
      wrap.className = "twoPip";
      wrap.appendChild(goalSpan(from));
      var arrow = document.createElement("span");
      arrow.className = "arrow";
      arrow.textContent = "→";
      wrap.appendChild(arrow);
      wrap.appendChild(goalSpan(to));
      tdThrow.appendChild(wrap);
      tr.appendChild(tdThrow);

      var tdP = document.createElement("td");
      tdP.textContent = ""+p;
      tr.appendChild(tdP);

      var td1 = document.createElement("td");
      td1.appendChild(makeDeltaSelect(hole, 1, p));
      tr.appendChild(td1);

      var td2 = document.createElement("td");
      td2.appendChild(makeDeltaSelect(hole, 2, p));
      tr.appendChild(td2);

      mainBody.appendChild(tr);

      if (hole === 9){
        mainBody.appendChild(buildFront9Row(parFront));
      }
    }

    document.getElementById("parFrontTop").textContent = parFront;
    document.getElementById("parBackTop").textContent  = parBack;
    document.getElementById("parTotalTop").textContent = parTotal;
    document.getElementById("parBackCell").textContent = parBack;
    document.getElementById("parTotalCell").textContent = parTotal;

    recalcTotals();
    updateProgress();

    var st = loadState();
    if (st){
      n1.value = st.n1 || "";
      n2.value = st.n2 || "";
      syncPlayerHeaders();

      if (st.scores){
        for (var h=1; h<=HOLES; h++){
          if (!st.scores[h]) continue;
          setSelectValue(h, 1, st.scores[h].p1 || "");
          setSelectValue(h, 2, st.scores[h].p2 || "");
        }
        recolorAllSelects();
        recalcTotals();
        updateProgress();
      }
      setActiveHole(Math.max(1, Math.min(HOLES, st.activeHole || 1)), false);
    } else {
      syncPlayerHeaders();
      setActiveHole(1, false);
    }
  }

  function generateAndRender(){
    if (anyScoreEntered()){
      var ok = confirm("Generate a new course? This will reset scores for this round.");
      if (!ok) return;
    }

    syncPlayerHeaders();

    var r = generateCourse();
    if (!r){
      showToast("Could not generate course. Try again.");
      return;
    }

    setUrlForCourse(r.seq);
    renderAll(r.seq);

    clearSavedStateForCurrentCourse();
    for (var h=1; h<=HOLES; h++){
      setSelectValue(h, 1, "");
      setSelectValue(h, 2, "");
    }
    recolorAllSelects();
    recalcTotals();
    updateProgress();

    // IMPORTANT: no scroll on generation
    setActiveHole(1, false);

    saveState();
    haptic(15);
    showToast("New course generated");
  }

  btnGen.addEventListener("click", function(){ generateAndRender(); });
  btnClear.addEventListener("click", function(){ clearScores(true); });
  btnCopy.addEventListener("click", copyShareLink);

  function init(){
    syncPlayerHeaders();
    var url = new URL(window.location.href);
    var c = url.searchParams.get("c");
    var seq = decodeCourse(c);
    if (seq){
      renderAll(seq);
      setUrlForCourse(seq);
      showToast("Course loaded");
    } else {
      generateAndRender();
    }
  }

  init();
})();
</script>

</body>
</html>
